name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - develop
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - main
      - develop
  workflow_dispatch:

env:
  PYTHON_VERSION_DEFAULT: "3.11"

jobs:
  # ============================================================================
  # TEST JOB - Run pytest with coverage across all platforms
  # ============================================================================
  test:
    name: Test (Python ${{ matrix.python-version }} on ${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        python-version: ["3.10", "3.11", "3.12"]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Run tests with coverage
        run: |
          pytest --cov=src --cov-report=xml --cov-report=term-missing -v
      
      - name: Upload coverage to Codecov
        if: matrix.python-version == env.PYTHON_VERSION_DEFAULT && matrix.os == 'ubuntu-latest'
        uses: codecov/codecov-action@v3
        with:
          file: ./coverage.xml
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false

  # ============================================================================
  # LINT JOB - Code quality checks
  # ============================================================================
  lint:
    name: Lint
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
      
      - name: Check formatting with Black
        run: |
          black --check --diff src tests
      
      - name: Lint with Ruff
        run: |
          ruff check src tests
      
      - name: Type check with Mypy
        run: |
          mypy src --ignore-missing-imports --no-strict-optional
        continue-on-error: true

  # ============================================================================
  # BUILD JOB - Create executables for all platforms
  # ============================================================================
  build:
    name: Build (${{ matrix.os }})
    needs: [test, lint]
    runs-on: ${{ matrix.os }}
    
    strategy:
      matrix:
        include:
          - os: windows-latest
            artifact_name: Sims4ModManager-Windows.exe
            build_name: Sims4ModManager.exe
          - os: macos-latest
            artifact_name: Sims4ModManager-macOS.app
            build_name: Sims4ModManager.app
          - os: ubuntu-latest
            artifact_name: Sims4ModManager-Linux
            build_name: Sims4ModManager
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
          cache: 'pip'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install pyinstaller
      
      - name: Create placeholder assets (if missing)
        shell: bash
        run: |
          mkdir -p assets/fonts
          touch assets/fonts/.gitkeep
          # Icons will be created by build.py if missing
      
      - name: Build with build.py
        shell: bash
        run: |
          python build.py --clean
      
      - name: Locate executable
        shell: bash
        run: |
          echo "Contents of dist directory:"
          ls -la dist/
      
      - name: Upload artifact
        uses: actions/upload-artifact@v3
        with:
          name: ${{ matrix.artifact_name }}
          path: |
            dist/Sims4ModManager*
          retention-days: 30

  # ============================================================================
  # RELEASE JOB - Create GitHub release with executables
  # ============================================================================
  release:
    name: Create Release
    needs: [build]
    if: startsWith(github.ref, 'refs/tags/v')
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Download all artifacts
        uses: actions/download-artifact@v3
        with:
          path: artifacts
      
      - name: Display structure of downloaded files
        run: ls -R artifacts
      
      - name: Generate changelog
        id: changelog
        run: |
          echo "## What's Changed" > CHANGELOG.md
          git log $(git describe --tags --abbrev=0 HEAD^)..HEAD --pretty=format:"- %s (%h)" >> CHANGELOG.md
          echo "" >> CHANGELOG.md
          echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$(git describe --tags --abbrev=0 HEAD^)...${{ github.ref_name }}" >> CHANGELOG.md
          cat CHANGELOG.md
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Release ${{ github.ref_name }}
          body_path: CHANGELOG.md
          draft: false
          prerelease: false
          files: |
            artifacts/Sims4ModManager-Windows.exe/*
            artifacts/Sims4ModManager-macOS.app/*
            artifacts/Sims4ModManager-Linux/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ============================================================================
  # SECURITY SCAN - Check for vulnerabilities
  # ============================================================================
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION_DEFAULT }}
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install safety bandit
      
      - name: Check dependencies for known vulnerabilities
        run: |
          pip install -e "."
          safety check --json || true
        continue-on-error: true
      
      - name: Run Bandit security linter
        run: |
          bandit -r src -f json -o bandit-report.json || true
        continue-on-error: true
      
      - name: Upload security reports
        uses: actions/upload-artifact@v3
        with:
          name: security-reports
          path: |
            bandit-report.json
          retention-days: 30
